<launch>
    <!-- ============================================================ -->
    <!-- COMPREHENSIVE CLIO + REALSENSE LAUNCH FILE                  -->
    <!-- Direct approach without using clio_ros/realsense.launch     -->
    <!-- ============================================================ -->

    <!-- REALSENSE CAMERA PARAMETERS -->
    <arg name="camera_name" default="camera"/>
    <arg name="camera_namespace" default="camera"/> 
    <arg name="serial_no" default="" doc="Camera serial number (use _prefix for numbers)"/>
    <arg name="usb_port_id" default="" doc="USB port ID (e.g. 4-1)"/>
    <arg name="device_type" default="" doc="Device type filter (e.g. d435)"/>
    <arg name="initial_reset" default="false" doc="Reset camera before start"/>
    
    <!-- Camera stream configuration -->
    <arg name="enable_color" default="true"/>
    <arg name="enable_depth" default="true"/>
    <arg name="enable_infra1" default="false"/>
    <arg name="enable_infra2" default="false"/>
    <arg name="enable_pointcloud" default="true"/>
    <arg name="enable_sync" default="true" doc="Synchronize frames"/>
    <arg name="align_depth" default="true" doc="Align depth to color frames"/>
    <arg name="publish_tf" default="true"/>

    <!-- CLIO CONFIGURATION PARAMETERS -->
    <arg name="robot_id" default="0" doc="unique robot identifier"/>
    <arg name="robot_frame" default="$(arg camera_name)_link" doc="robot base frame (i.e., robot pose)"/>
    <arg name="odom_frame" default="world" doc="robot map frame"/>
    <arg name="map_frame" default="world" doc="backend scene graph frame"/>
    <arg name="sensor_frame" default="$(arg camera_name)_link"/>
    
    <!-- Dataset and configuration paths -->
    <arg name="dataset_name" default="realsense" doc="Dataset name (used for parsing config)"/>
    <arg name="ablation_name" default="realsense_fine" doc="Ablation name (used for parsing config)"/>
    
    <!-- Sensor configuration for CLIO -->
    <arg name="sensor_min_range" default="0.3" doc="minimum sensor range in meters"/>
    <arg name="sensor_max_range" default="4.0" doc="maximum sensor range in meters"/>
    
    <!-- TASK SERVER CONFIGURATION -->
    <arg name="object_tasks_file" default="" doc="File to read object tasks from (empty = use environment default)"/>
    <arg name="place_tasks_file" default="" doc="File to read place tasks from (empty = use environment default)"/>
    
    <!-- Environment-specific configuration -->
    <arg name="environment" default="office" doc="Environment type: office, supermarket, home, or custom" />
    
    <!-- Auto-select environment files if not explicitly provided -->
    <arg name="auto_object_tasks_file" value="$(find clio_annotator)/environments/$(arg environment)/tasks.yaml" />
    <arg name="auto_place_tasks_file"  value="$(find clio_annotator)/environments/$(arg environment)/regions.yaml" />
    
    <!-- Use environment files if standard paths not overridden -->
    <arg name="final_object_tasks_file" value="$(arg object_tasks_file)" if="$(eval arg('object_tasks_file') != '')" />
    <arg name="final_object_tasks_file" value="$(arg auto_object_tasks_file)" unless="$(eval arg('object_tasks_file') != '')" />
    
    <arg name="final_place_tasks_file" value="$(arg place_tasks_file)" if="$(eval arg('place_tasks_file') != '')" />
    <arg name="final_place_tasks_file" value="$(arg auto_place_tasks_file)" unless="$(eval arg('place_tasks_file') != '')" />

    <!-- VISUALIZATION CONFIGURATION -->
    <arg name="start_visualizer" default="true" doc="Start visualizer node (disabled for headless)"/>
    <arg name="start_rviz" default="true" doc="Start rviz (disabled for headless)"/>

    <!-- ============================================================ -->
    <!-- LAUNCH REALSENSE CAMERA NODE                                -->
    <!-- ============================================================ -->
    
    <include file="$(find realsense2_camera)/launch/rs_camera.launch">
        <arg name="camera" value="$(arg camera_name)"/>
        <arg name="serial_no" value="$(arg serial_no)" if="$(eval arg('serial_no') != '')"/>
        <arg name="usb_port_id" value="$(arg usb_port_id)" if="$(eval arg('usb_port_id') != '')"/>
        <arg name="device_type" value="$(arg device_type)" if="$(eval arg('device_type') != '')"/>
        <arg name="initial_reset" value="$(arg initial_reset)"/>
        
        <!-- Stream configuration -->
        <arg name="enable_color" value="$(arg enable_color)"/>
        <arg name="enable_depth" value="$(arg enable_depth)"/>
        <arg name="enable_infra1" value="$(arg enable_infra1)"/>
        <arg name="enable_infra2" value="$(arg enable_infra2)"/>
        <arg name="enable_sync" value="$(arg enable_sync)"/>
        <arg name="align_depth" value="$(arg align_depth)"/>
        <arg name="enable_pointcloud" value="$(arg enable_pointcloud)"/>
        <arg name="publish_tf" value="$(arg publish_tf)"/>
    </include>

    <!-- ============================================================ -->
    <!-- ENVIRONMENT SETUP                                           -->
    <!-- ============================================================ -->
    
    <!-- Override sim_time since we're using real camera -->
    <param name="use_sim_time" value="false"/>
    
    <!-- Global topic remapping to connect RealSense camera to CLIO -->
    <remap from="/dominic/forward/color/image_raw" to="/$(arg camera_name)/color/image_raw"/>
    <remap from="/dominic/forward/depth/image_rect_raw" to="/$(arg camera_name)/aligned_depth_to_color/image_raw"/>
    <remap from="/dominic/forward/semantic/image_raw" to="/$(arg camera_name)/semantic/image_raw"/>
    <remap from="/dominic/forward/semantic/clip_vector" to="/$(arg camera_name)/semantic/clip_vector"/>

    <!-- ============================================================ -->
    <!-- SEMANTIC INFERENCE                                          -->
    <!-- ============================================================ -->
    
    <arg name="segmenter_config" default="$(find clio_ros)/config/segmentation/large_clip.yaml" doc="openset segmentation config to use"/>
    <arg name="run_segmentation" default="true"/>
    
    <group if="$(arg run_segmentation)">
        <remap from="semantic_inference/color/image_raw" to="/dominic/forward/color/image_raw"/>
        <remap from="semantic_inference/semantic/image_raw" to="/dominic/forward/semantic/image_raw"/>
        <remap from="semantic_inference/semantic/feature" to="/dominic/forward/semantic/clip_vector"/>
        <include file="$(find semantic_inference_ros)/launch/openset_segmentation.launch">
            <arg name="config_path" value="$(arg segmenter_config)"/>
        </include>
    </group>

    <group unless="$(arg run_segmentation)">
        <node pkg="semantic_inference_ros" type="language_embedding_node" name="semantic_inference">
            <rosparam file="$(arg segmenter_config)"/> <!-- sets model name -->
        </node>
    </group>

    <!-- ============================================================ -->
    <!-- CLIO LAUNCH                                                 -->
    <!-- ============================================================ -->
    
    <arg name="run_clio" default="true"/>
    <group if="$(arg run_clio)">
        <remap from="/clio_node/input/camera/rgb/image_raw" to="/dominic/forward/color/image_raw"/>
        <remap from="/clio_node/input/camera/depth_registered/image_rect" to="/dominic/forward/depth/image_rect_raw"/>
        <remap from="/clio_node/input/camera/semantic/image_raw" to="/dominic/forward/semantic/image_raw"/>
        <remap from="/clio_node/input/camera/feature" to="/dominic/forward/semantic/clip_vector"/>
        
        <include file="$(find clio_ros)/launch/clio.launch">
            <!-- Frame configuration -->
            <arg name="robot_id" value="$(arg robot_id)"/>
            <arg name="robot_frame" value="$(arg robot_frame)"/>
            <arg name="odom_frame" value="$(arg odom_frame)"/>
            <arg name="map_frame" value="$(arg map_frame)"/>
            
            <!-- Dataset configuration -->
            <arg name="dataset_name" value="$(arg dataset_name)"/>
            <arg name="ablation_name" value="$(arg ablation_name)"/>
            
            <!-- Sensor configuration -->
            <arg name="sensor_min_range" value="$(arg sensor_min_range)"/>
            <arg name="sensor_max_range" value="$(arg sensor_max_range)"/>
            
            <!-- Task server configuration -->
            <arg name="object_tasks_file" value="$(arg final_object_tasks_file)"/>
            <arg name="place_tasks_file" value="$(arg final_place_tasks_file)"/>
            
            <!-- Visualization - Disable GUI components for headless operation -->
            <arg name="start_visualizer" value="$(arg start_visualizer)"/>
            <arg name="start_rviz" value="$(arg start_rviz)"/>
        </include>
    </group>

</launch>